// Conditional imports for notifications (only available in dev builds, not Expo Go)
let Notifications: any = null;
let Device: any = null;

try {
  // These will work in development builds
  Notifications = require('expo-notifications');
  Device = require('expo-device');
  console.log('üì± Notifications available - running in development build');
} catch (error) {
  console.log('üì± Notifications not available in Expo Go - this is normal for SDK 53+');
}

import Constants from 'expo-constants';
import { Platform } from 'react-native';
import { doc, updateDoc, collection, addDoc, Timestamp } from 'firebase/firestore';
import { db } from '../lib/firebase';

// Configure notification behavior (only if notifications are available)
if (Notifications) {
  Notifications.setNotificationHandler({
    handleNotification: async () => ({
      shouldShowAlert: true,
      shouldPlaySound: true,
      shouldSetBadge: true,
    }),
  });
}

export interface PushNotificationToken {
  token: string;
  userId: string;
  deviceId: string;
  platform: string;
  createdAt: Date;
  lastUpdated: Date;
}

export interface NotificationPreferences {
  enabled: boolean;
  supportMessages: boolean;
  paymentUpdates: boolean;
  wellnessReminders: boolean;
  careRequests: boolean;
  weeklyReports: boolean;
}

export interface NotificationData {
  type: 'support_received' | 'payment_received' | 'wellness_reminder' | 'care_request' | 'payment_status' | 'weekly_report';
  title: string;
  body: string;
  data?: { [key: string]: any };
  userId: string;
  priority?: 'default' | 'high';
  sound?: 'default' | 'none';
}

class PushNotificationService {
  private token: string | null = null;
  private isInitialized = false;

  /**
   * Initialize push notifications and register device token
   */
  async initialize(userId: string): Promise<string | null> {
    try {
      console.log('üîî Initializing push notifications...');

      // Check if notifications are available (not in Expo Go with SDK 53+)
      if (!Notifications || !Device) {
        console.log('‚ö†Ô∏è Push notifications not available in Expo Go - use development build for notifications');
        return null;
      }

      // Check if device supports push notifications
      if (!Device.isDevice) {
        console.log('‚ö†Ô∏è Push notifications only work on physical devices');
        return null;
      }

      // Request permissions
      const { status: existingStatus } = await Notifications.getPermissionsAsync();
      let finalStatus = existingStatus;

      if (existingStatus !== 'granted') {
        console.log('üì± Requesting notification permissions...');
        const { status } = await Notifications.requestPermissionsAsync();
        finalStatus = status;
      }

      if (finalStatus !== 'granted') {
        console.log('‚ùå Notification permissions denied');
        return null;
      }

      // Get push token
      let projectId = Constants.expoConfig?.extra?.eas?.projectId ?? Constants.easConfig?.projectId;
      
      // Fallback for development without EAS
      if (!projectId) {
        console.warn('‚ö†Ô∏è No EAS project ID found. Using Firebase project ID as fallback for development.');
        projectId = process.env.EXPO_PUBLIC_FIREBASE_PROJECT_ID;
      }
      
      const tokenData = await Notifications.getExpoPushTokenAsync({
        projectId: projectId,
      });

      this.token = tokenData.data;
      this.isInitialized = true;

      console.log('‚úÖ Push notification token obtained:', this.token);

      // Store token in Firebase
      await this.saveTokenToFirebase(userId, this.token);

      // Set up notification received listener
      this.setupNotificationListeners();

      return this.token;

    } catch (error) {
      console.error('‚ùå Error initializing push notifications:', error);
      return null;
    }
  }

  /**
   * Save push token to Firebase for this user
   */
  private async saveTokenToFirebase(userId: string, token: string): Promise<void> {
    try {
      const deviceId = Constants.deviceId || 'unknown';
      
      const tokenData: Omit<PushNotificationToken, 'id'> = {
        token,
        userId,
        deviceId,
        platform: Platform.OS,
        createdAt: new Date(),
        lastUpdated: new Date()
      };

      // Update user document with latest token and default notification preferences
      const defaultPreferences: NotificationPreferences = {
        enabled: true,
        supportMessages: true,
        paymentUpdates: true,
        wellnessReminders: true,
        careRequests: true,
        weeklyReports: true
      };

      console.log('üíæ Setting notification preferences for user:', userId, defaultPreferences);

      await updateDoc(doc(db, 'users', userId), {
        pushToken: token,
        pushTokenUpdatedAt: Timestamp.now(),
        deviceInfo: {
          platform: Platform.OS,
          deviceId
        },
        notificationPreferences: defaultPreferences
      });

      // Also store in dedicated push_tokens collection for easier querying
      await addDoc(collection(db, 'push_tokens'), {
        ...tokenData,
        createdAt: Timestamp.fromDate(tokenData.createdAt),
        lastUpdated: Timestamp.fromDate(tokenData.lastUpdated)
      });

      console.log('üíæ Push token saved to Firebase');

    } catch (error) {
      console.error('‚ùå Error saving push token:', error);
    }
  }

  /**
   * Set up listeners for notification interactions
   */
  private setupNotificationListeners(): void {
    if (!Notifications) {
      console.log('‚ö†Ô∏è Notifications not available - skipping listener setup');
      return;
    }

    // Handle notification received while app is running
    Notifications.addNotificationReceivedListener(notification => {
      console.log('üîî Notification received:', notification);
    });

    // Handle notification tapped/opened
    Notifications.addNotificationResponseReceivedListener(response => {
      console.log('üëÜ Notification tapped:', response);
      
      const data = response.notification.request.content.data;
      if (data?.type) {
        this.handleNotificationTap(data);
      }
    });
  }

  /**
   * Handle when user taps on a notification
   */
  private handleNotificationTap(data: any): void {
    console.log('üéØ Handling notification tap:', data);
    
    // You can add navigation logic here based on notification type
    switch (data.type) {
      case 'support_received':
        // Navigate to messages screen
        break;
      case 'payment_received':
        // Navigate to activity screen
        break;
      case 'wellness_reminder':
        // Navigate to wellness screen
        break;
      case 'care_request':
        // Navigate to support requests
        break;
      default:
        console.log('Unknown notification type:', data.type);
    }
  }

  /**
   * Send a local notification (for testing)
   */
  async sendLocalNotification(title: string, body: string, data?: any): Promise<void> {
    if (!Notifications) {
      console.log('‚ö†Ô∏è Local notifications not available in Expo Go - use development build');
      return;
    }

    try {
      await Notifications.scheduleNotificationAsync({
        content: {
          title,
          body,
          data: data || {},
          sound: 'default',
        },
        trigger: null, // Send immediately
      });

      console.log('üì± Local notification sent');
    } catch (error) {
      console.error('‚ùå Error sending local notification:', error);
    }
  }

  /**
   * Check if user has enabled a specific notification type
   */
  async checkNotificationPreferences(userId: string, notificationType: string): Promise<boolean> {
    try {
      const { doc: firestoreDoc, getDoc } = await import('firebase/firestore');
      const { db } = await import('../lib/firebase');
      
      const userDoc = await getDoc(firestoreDoc(db, 'users', userId));
      if (!userDoc.exists()) return false;
      
      const userData = userDoc.data();
      const preferences = userData.notificationPreferences as NotificationPreferences;
      
      if (!preferences || !preferences.enabled) return false;
      
      // Check specific notification type preferences
      switch (notificationType) {
        case 'support_received':
          return preferences.supportMessages;
        case 'payment_received':
        case 'payment_status':
          return preferences.paymentUpdates;
        case 'wellness_reminder':
          return preferences.wellnessReminders;
        case 'care_request':
          return preferences.careRequests;
        case 'weekly_report':
          return preferences.weeklyReports;
        default:
          return true; // Default to enabled for unknown types
      }
    } catch (error) {
      console.error('Error checking notification preferences:', error);
      return true; // Default to enabled if we can't check
    }
  }

  /**
   * Send push notification via Firebase Cloud Function
   */
  async sendPushNotification(notification: NotificationData): Promise<boolean> {
    try {
      // Call Firebase Cloud Function to send the notification
      const { httpsCallable } = await import('firebase/functions');
      const { functions } = await import('../lib/firebase');
      
      const sendNotification = httpsCallable(functions, 'sendPushNotification');
      
      const result = await sendNotification({
        userId: notification.userId,
        type: notification.type,
        title: notification.title,
        body: notification.body,
        notificationData: notification.data || {}
      });

      const data = result.data as any;
      console.log('üì§ Push notification sent via Cloud Function:', data);
      
      return data.success === true;
    } catch (error) {
      console.error('‚ùå Error sending push notification via Cloud Function:', error);
      
      // Fallback to direct Expo API call for development/testing
      console.log('üîÑ Falling back to direct Expo API call...');
      return this.sendPushNotificationDirect(notification);
    }
  }

  /**
   * Fallback method: Send push notification directly to Expo (for development)
   */
  private async sendPushNotificationDirect(notification: NotificationData): Promise<boolean> {
    try {
      // Check if user has enabled this notification type
      const isEnabled = await this.checkNotificationPreferences(notification.userId, notification.type);
      if (!isEnabled) {
        console.log('üìµ Notification disabled for user:', notification.userId, notification.type);
        return false;
      }

      // Get user's push token
      const { doc: firestoreDoc, getDoc } = await import('firebase/firestore');
      const { db } = await import('../lib/firebase');
      
      const userDoc = await getDoc(firestoreDoc(db, 'users', notification.userId));
      if (!userDoc.exists()) {
        console.log('üìµ User not found:', notification.userId);
        return false;
      }
      
      const userData = userDoc.data();
      const userToken = userData.pushToken;
      
      if (!userToken) {
        console.log('üìµ No push token for user:', notification.userId);
        return false;
      }

      // Direct call to Expo API (fallback for development)
      const response = await fetch('https://exp.host/--/api/v2/push/send', {
        method: 'POST',
        headers: {
          Accept: 'application/json',
          'Accept-encoding': 'gzip, deflate',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          to: userToken,
          title: notification.title,
          body: notification.body,
          data: {
            ...notification.data,
            type: notification.type,
            userId: notification.userId
          },
          priority: notification.priority || 'default',
          sound: notification.sound || 'default'
        }),
      });

      const result = await response.json();
      console.log('üì§ Push notification sent (direct):', result);
      
      return result.data?.status === 'ok';
    } catch (error) {
      console.error('‚ùå Error sending push notification (direct):', error);
      return false;
    }
  }

  /**
   * Clear all notifications
   */
  async clearAllNotifications(): Promise<void> {
    if (!Notifications) {
      console.log('‚ö†Ô∏è Notification clearing not available in Expo Go - use development build');
      return;
    }

    try {
      await Notifications.dismissAllNotificationsAsync();
      console.log('üßπ All notifications cleared');
    } catch (error) {
      console.error('‚ùå Error clearing notifications:', error);
    }
  }

  /**
   * Get current push token
   */
  getToken(): string | null {
    return this.token;
  }

  /**
   * Check if notifications are initialized
   */
  isReady(): boolean {
    return this.isInitialized && !!this.token;
  }

  /**
   * Schedule daily wellness reminders for students
   */
  async scheduleDailyWellnessReminder(userId: string): Promise<void> {
    if (!Notifications) {
      console.log('‚ö†Ô∏è Notification scheduling not available in Expo Go - use development build');
      return;
    }

    try {
      // Check if user is a student
      const { getUserProfile } = await import('../lib/firebase');
      const userProfile = await getUserProfile(userId);
      
      if (!userProfile || userProfile.user_type !== 'student') {
        return;
      }

      // Schedule notification for 8 PM daily
      const now = new Date();
      const reminderTime = new Date();
      reminderTime.setHours(20, 0, 0, 0); // 8:00 PM
      
      // If it's already past 8 PM today, schedule for tomorrow
      if (now.getTime() > reminderTime.getTime()) {
        reminderTime.setDate(reminderTime.getDate() + 1);
      }

      await Notifications.scheduleNotificationAsync({
        content: {
          title: NotificationTemplates.wellnessReminder().title,
          body: NotificationTemplates.wellnessReminder().body,
          data: {
            type: 'wellness_reminder',
            userId
          },
          sound: 'default',
        },
        trigger: {
          date: reminderTime,
          repeats: true,
        },
      });

      console.log('üìÖ Scheduled daily wellness reminder for', reminderTime);
    } catch (error) {
      console.error('‚ùå Error scheduling wellness reminder:', error);
    }
  }

  /**
   * Cancel all scheduled notifications for a user
   */
  async cancelScheduledNotifications(): Promise<void> {
    if (!Notifications) {
      console.log('‚ö†Ô∏è Notification canceling not available in Expo Go - use development build');
      return;
    }

    try {
      await Notifications.cancelAllScheduledNotificationsAsync();
      console.log('üóëÔ∏è Cancelled all scheduled notifications');
    } catch (error) {
      console.error('‚ùå Error cancelling notifications:', error);
    }
  }
}

// Export singleton instance
export const pushNotificationService = new PushNotificationService();

// Convenience functions for different notification types
export const NotificationTemplates = {
  supportReceived: (senderName: string, message: string): Omit<NotificationData, 'userId'> => ({
    type: 'support_received',
    title: `üíô Support from ${senderName}`,
    body: message.length > 100 ? `${message.substring(0, 100)}...` : message,
    priority: 'high',
    data: { senderName }
  }),

  paymentReceived: (amount: string, senderName: string): Omit<NotificationData, 'userId'> => ({
    type: 'payment_received',
    title: `üí∞ Payment Received!`,
    body: `You received ${amount} from ${senderName}`,
    priority: 'high',
    data: { amount, senderName }
  }),

  wellnessReminder: (): Omit<NotificationData, 'userId'> => ({
    type: 'wellness_reminder',
    title: `üåü Daily Check-in`,
    body: `Don't forget to log your wellness for today!`,
    priority: 'default',
  }),

  careRequest: (studentName: string, message: string): Omit<NotificationData, 'userId'> => ({
    type: 'care_request',
    title: `üÜò Care Request from ${studentName}`,
    body: message,
    priority: 'high',
    data: { studentName }
  }),

  rewardRequest: (studentName: string, rewardTitle: string, amount: number): Omit<NotificationData, 'userId'> => ({
    type: 'reward_request',
    title: `üéâ Reward Request from ${studentName}`,
    body: `${studentName} earned "${rewardTitle}" worth $${amount}`,
    priority: 'high',
    data: { studentName, rewardTitle, amount: amount.toString() }
  }),

  paymentStatus: (status: string, amount: string): Omit<NotificationData, 'userId'> => ({
    type: 'payment_status',
    title: `üí≥ Payment ${status}`,
    body: `Your ${amount} payment has been ${status.toLowerCase()}`,
    priority: 'default',
    data: { status, amount }
  }),

  weeklyReport: (studentName: string, score: number): Omit<NotificationData, 'userId'> => ({
    type: 'weekly_report',
    title: `üìä Weekly Report: ${studentName}`,
    body: `Wellness score this week: ${score}/10`,
    priority: 'default',
    data: { studentName, score }
  })
};